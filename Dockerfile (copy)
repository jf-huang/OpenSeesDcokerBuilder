FROM ubuntu

# basic packages
ENV DEBIAN_FRONTEND noninteractive
RUN apt-get -y update && \
apt-get -y install build-essential gcc gfortran make dkms tcl8.6-dev zlib1g-dev flex bison && \ 
apt-get -y upgrade
ENV mainDir /home/jfhuang

# mpich
WORKDIR $mainDir
COPY mpich2-1.5rc3.tar.gz .
RUN tar -xzf ./mpich2-1.5rc3.tar.gz && \
rm -r mpich2-1.5rc3.tar.gz && \ 
cd ./mpich2-1.5rc3 && \
./configure --prefix=$mainDir-mpiInstall 2>&1 | tee c.txt && \
make 2>&1 | tee m.txt && \
make install 2>&1 | tee mi.txt && \
sed '$a export PATH=$PATH:$mainDir-mpiInstall/bin' /etc/profile && \
export PATH=$PATH:$mainDir-mpiInstall/bin && \
echo $(which mpicc)

# blas, lapack and scalapack
COPY blas-3.8.0.tgz lapack-3.9.0.tar.gz scalapack-2.1.0.tar.gz ./
RUN apt-get -y install python && \
export PATH=$PATH:$mainDir-mpiInstall/bin && \
tar -xzf blas-3.8.0.tgz && \
cd BLAS-3.8.0 && make && mv blas_LINUX.a libblas.a && \
cp libblas.a /usr/local/lib/ && \
cd .. && tar -xzf lapack-3.9.0.tar.gz && \
cd lapack-3.9.0 && mv make.inc.example make.inc && ulimit -s unlimited && make && \
cp liblapack.a /usr/local/lib/ && \
cd .. && tar -xzf scalapack-2.1.0.tar.gz && \
cd scalapack-2.1.0 && mv SLmake.inc.example SLmake.inc && make && \
cp libscalapack.a /usr/local/lib/

# metis and parmetis, installed in /usr/local by default
COPY metis-5.1.0.tar.gz parmetis-4.0.3.tar.gz ./
RUN export PATH=$PATH:$mainDir-mpiInstall/bin && \
tar -xzf metis-5.1.0.tar.gz && cd metis-5.1.0 && \
sed -i 's/#define IDXTYPEWIDTH 32/#define IDXTYPEWIDTH 64/g' ./include/metis.h && make && make install && \
cd .. && tar -xzf parmetis-4.0.3.tar.gz && cd parmetis-4.0.3 && \
sed -i 's/#define IDXTYPEWIDTH 32/#define IDXTYPEWIDTH 64/g' ./metis/include/metis.h && make && make install


# scotch and pscotch, installed in /usr/local by default
COPY scotch_6.0.9.tar.gz ./
RUN export PATH=$PATH:$mainDir-mpiInstall/bin && \
tar -xzf scotch_6.0.9.tar.gz && cd scotch_6.0.9 && \
cd src && cp Make.inc/Makefile.inc.x86-64_pc_linux2 Makefile.inc && \
sed -i 's/CCD		= gcc/CCD		= mpicc/g' Makefile.inc && \
make ptscotch && make install

# mumps
COPY mumps_5.1.2.orig.tar.gz ./
RUN export PATH=$PATH:$mainDir-mpiInstall/bin && \
tar -xzf mumps_5.1.2.orig.tar.gz && cd MUMPS_5.1.2 && \
cp Make.inc/Makefile.inc.generic Makefile.inc && \
sed -i 's:#SCOTCHDIR  = ${HOME}/scotch_6.0:SCOTCHDIR  = /usr/local:g' Makefile.inc && \
sed -i 's:#ISCOTCH    = -I$(SCOTCHDIR)/include:ISCOTCH    = -I$(SCOTCHDIR)/include:g' Makefile.inc && \
sed -i 's:#LSCOTCH    = -L$(SCOTCHDIR)/lib -lptesmumps -lptscotch -lptscotcherr:LSCOTCH    = -L$(SCOTCHDIR)/lib -lptesmumps -lptscotch -lptscotcherr:g' Makefile.inc && \
sed -i 's:#LMETISDIR = /opt/metis-5.1.0/build/Linux-x86_64/libmetis:LMETISDIR = /usr/local/lib:g' Makefile.inc && \
sed -i 's:#IMETIS    = /opt/metis-5.1.0/include:IMETIS    = /usr/local/include:g' Makefile.inc && \
sed -i 's:#LMETIS    = -L$(LMETISDIR) -lparmetis -lmetis:LMETIS    = -L$(LMETISDIR) -lparmetis -lmetis:g' Makefile.inc && \
sed -i 's:#ORDERINGSF = -Dscotch -Dmetis -Dpord -Dptscotch -Dparmetis:ORDERINGSF = -Dscotch -Dmetis -Dpord -Dptscotch -Dparmetis:g' Makefile.inc && \
sed -i 's:CC      = cc:CC      = mpicc:g' Makefile.inc && \
sed -i 's:FC      = f90:FC      = mpif90:g' Makefile.inc && \
sed -i 's:FL      = f90:FL      = mpif90:g' Makefile.inc && \
sed -i 's:INCPAR  = -I/usr/include:INCPAR  = -I${mainDir}-mpiInstall:g' Makefile.inc && \
sed -i 's:OPTF    = -O:OPTF    = -O -I${mainDir}/scotch_6.0.9/include -I${mainDir}-mpiInstall:g' Makefile.inc && \
sed -i 's:OPTC    = -O -I.:OPTC    = -O -I. -I${mainDir}/scotch_6.0.9/include:g' Makefile.inc && \
make alllib

# petsc
COPY v2.2.1.petsc.tar.gz ./
RUN export PATH=$PATH:$mainDir-mpiInstall/bin && \
tar -xzf v2.2.1.petsc.tar.gz && cd petsc-2.2.1 && \
PETSC_DIR=`pwd` && export PETSC_DIR && \
./config/configure.py --with-shared=0 && \
make all && make test

# hdf5
COPY CMake-hdf5-1.10.4.tar.gz ./
RUN apt-get -y install cmake && export PATH=$PATH:$mainDir-mpiInstall/bin && \
tar -xzf CMake-hdf5-1.10.4.tar.gz && cd CMake-hdf5-1.10.4/ && cd hdf5-1.10.4 && \
./configure --prefix=/usr/local/hdf5 --enable-parallel --enable-build-mode=production --disable-shared && \
#make && make check && make install && make check-install
make && make install && make check-install


# opensees
RUN apt-get -y install git && \
git clone https://github.com/jf-huang/OpenSees.git && \
cd OpenSees && sed -i 's:HOME  = /home/jfhuang:HOME  = ${mainDir}:g' Makefile.def && \
sed -i 's:MUMPS_DIR = /home/jfhuang/Downloads/MUMPS_5.1.2:MUMPS_DIR = ${mainDir}/MUMPS_5.1.2:g' Makefile.def && \
export PATH=$PATH:$mainDir-mpiInstall/bin && \
make

RUN export PATH=$PATH:$mainDir-mpiInstall/bin && \
ls /usr/local/ && \
cd OpenSees && sed -i 's:include Makefile.def:include Makefile.:g' Makefile && \
make wipe && make




















